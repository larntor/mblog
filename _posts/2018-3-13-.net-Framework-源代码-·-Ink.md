---
title: ".net Framework 源代码 · Ink"
author: lindexi
date: 2018-3-13 19:37:41 +0800
CreateTime: 2018-2-22 10:6:5 +0800
categories: .net Framework 源代码分析 WPF ink 笔迹
---

本文是分析 .net Framework 源代码的系列，主要告诉大家微软做笔迹用的思路，怎么做的笔迹才是高性能的，用户体验比较好的。我会告诉大家源代码的思想，当然这个文章会比较无聊。如果你是想做笔迹的，即使不是 WPF 开发，不是 C# 开发的，也可以看看，因为这个思想是微软的，相对还是比较好的。

<!--more-->


<!-- csdn -->
<!-- 草稿 -->

<!-- 标签：.net Framework，源代码分析，wpf，ink，笔迹 -->

<div id="toc"></div>

本文开始先让大家简单使用微软的 Ink 试试他是如何做的。

## 使用

通过源代码的方式使用，在 WPF 、UWP 是很简单的，因为现在我不知道怎么去拿 UWP 的源代码，只会使用，所以本文分析的源代码都是 .net Framework 4.7 的，不会说道 UWP 的笔迹。因为 UWP 的笔迹做的比 WPF 好很多，而且下面讲的源代码是在 2011 年写的到现在微软都没有修改。

## 思想

国际惯例，系统调度的单位是线程，如果一个线程做了很多事情，那么这个线程对每个事情做的时间将会比较少。为了做到在用户触摸的时候就显示用户触摸的点，就需要使用一个线程在检查是否有用户输入，画出来。

在 Ink 也是这样，Ink实际上分为两层，一个是动态笔迹，一个是 static 的。那么什么是动态笔迹？实际上在用户触摸的时候，为了立刻画出来，所以用的是一个新的 UI 线程。看到这里是不是觉得有黑科技，是的，UI是可以使用多线程的，请看[WPF 同一窗口内的多线程 UI（VisualTarget） - walterlv](https://walterlv.github.io/post/multi-thread-ui-using-visualtarget-in-wpf.html )

为什么需要在一个新的 UI 线程画出？原因是核心的线程可能需要画很多其它的元素，在用户可以画的时候，如果这时有计时器，他控制界面的元素，那么UI线程就需要处理计时器的内容，而且有很多开发者会在核心线程写一些代码，这些代码都需要时间。微软的笔是给所有开发者用，所以他不能告诉用户，在用的时候不能在核心线程做其他的功能，不然就没法很快画。为了让用户在核心线程做的不会影响到画的，大法就创建了一个新线程，这个线程就只绘制用户输入的点。这一个线程画出的在用户抬手就消失，所以叫动态笔迹。

大家觉得上面这个解释还不对，实际上大法画出的笔如果使用用户画到哪就显示，那么看到来的笔一点也不顺，很粗糙。需要收集很多点做优化，现在我使用的是自己修改的贝塞尔算法，这个算法可以画出很好的笔。但是上面说了动态笔迹是用户检测到摸到屏幕就画，但是收集很多点才可以算出用户的线，可以看到动态笔迹说的就是在显示的时候还支持不停修改，也就是画出的线不是最后显示的线，在画的时候就可以不停修改。

那么static笔迹是什么，实际上我找不到一个比较好的翻译，所以直接使用了部分英文。在用户抬手时，就从收集到的点计算出最后画出的线，而且画出来的线就不会修改了。

## 收集点

在 WPF 可以通过 Stylus 收集按下和移动这些，但是大家也知道，路由事件是需要时间比较长的，可能在 Ink 收到之前，就有其他元素收到，他在收到的做了很多其他的业务，这时就会影响笔的画。为了在用户一按下就开始画，需要用到黑科技。所有的 UIElement 都有 Pulgin ，这个属性可以从 UIElement 拿到原始的触摸，这样可以比路由事件更快拿到用户按下。从这里拿到的触摸可能是在其他线程。

## StylusPlugIns 

如果需要做出[高性能的笔](https://lindexi.gitee.io/post/WPF-%E9%AB%98%E6%80%A7%E8%83%BD%E7%AC%94.html) 那么就需要了解 [StylusPlugIns](https://docs.microsoft.com/en-us/dotnet/api/system.windows.input.stylusplugins?view=netframework-4.7.1)

在 Ink 底层的动态笔迹就是使用这个技术。

