---
layout: post
title:  C# 解析数学函数 
category: 技术 
---

最近需要做一功能，用户输入一次函数，我画出来。

于是我需要写一个函数，他可以把用户输入的数学函数转换为C# 代码。

<!--more-->

最简单方法，是把数学函数转化为C#代码，使用编译。

我的方法比较复杂。

先从简单的到复杂的来讲。

用户的输入都是各种各样，难点在如何解析用户的输入。最好的做法是，没有最好的做法。

如果你有听说过逆波兰法，那么忘掉他，下面的内容不会用到逆波兰法，虽然逆波兰法很好用，但是仅限于学术，现实用到他不多。

用户输入的数据，并不是那么好的解析，而且逆波兰法很难适应添加功能，必须在设计时候就需要知道有哪些功能。

如果有一天，我添加了一个符号，是把AB异或后相加，那么如果用逆波兰法，必须把算法推翻重新写。

但是显然不能用这个方法，实际需要可以轻松添加功能，这就是比较难的地方。

这可以怎么做呢？

首先需要归约用户的输入，用户的输入总是很复杂，例如在这里写个`x(`，这是什么呢？这里是`x*(` ，这里在括号之前有个乘号，但是用户不一定会输入，用户习惯不输入。 

然后，除了输入之外，还有其它的坑。

这就是说，用户可能输入 `+1` 这是正负，要把正负给识别出来，这部分挺难的。还有，我如果写个`2x`，是`2*x` ，必须把覆盖这些所有的条件，把他们给归约了，把他们变成程序可以识别格式。他就涉及到在哪个地方添加乘号，在什么地方要把+—转正负号。还有去掉用户的一些错误输入，并且在用户错误输入时候提出来。

第一步相对比较简单，他还是可以做到，只要有时间，理解不难。

下面说的相对比较难。

解析完了之后，变成函数分割，数组每一行，就是一个字符串。我通过观察他发现，发现数学可以分为数值和函数。函数就是`+-`这些。那么接下来开始说如何解析函数分割。

一开始，函数就可以分为，数值和函数。是的，函数是函数、数值也是函数，他们继承都是函数，于是输入一个数学函数，直接求解。但是函数里有函数，于是就是递归，一个问题，可以转地递归，就会变得很简单。

这就是面向对象的东西。

只需要写两个东西，一个是解析数值，一个是解析函数。

这样就解决了。

第一个就是需要找出里面的函数和数值，自变量属于哪个？其实随便，你认为是哪个就是哪个。

找出里面的函数的话，很简单，刚才已经有解析函数，进入递归就好了。然后就是找出数值，解析数值。

但是函数可能存在有些函数，需要输入参数可能是在函数的前面或后面，如`+`，就是需要输入函数的左右参数，例如`tan` 需要输入右边一个参数，那么如何读取他需要多少个参数，如何读取参数，这又是比较难的地方。

开始定义函数，函数包含函数，于是包含的函数叫s函数，数值和函数都继承函数，但是函数有很多，可以让以后添加新的函数。函数需要有参数，参数也是函数。

假如函数`Add`继承函数，那么可以在`Add`添加两个属性，表示他需要多少个参数，一个表示他需要从前面拿多少个参数，一个表示从右边拿多少个参数。

但是从左边拿的，是运行输入的，从右边拿的，解析需要放进去。

读到括号，可以认为他是一个函数，直接放在s函数。如果读到`)`和一些认为是函数结束的符号，那么结束函数。

具体是如何，请看下面。

下面来说下，不用编译直接解析用户输入的字符。

算法有三步，第一步就是把输入的字符串变成函数分割，第二步转换数学函数，第三步运行数学函数。

首先，需要知道，一个数学表达式可以写成：


```csharp
    1+2+3
```

也就是数值和运算，只有这两个，所以开始是需要把数和运算分出来。

这就是第一步主要做的，分开所有的数值和符号。

然后发现运算有单目和双目。


```csharp
    sin(x+1)
```

其中 `sin` 就是单目运算，`+`就是双目运算。

于是可以认为每个项都可以分出来。


```csharp
    1+2+sin(x+1)= 1  (+2)  (+(sin(x+1)))
```

把数值和运算符算出的结果都看成一个类。

是的，他可以是一个数值、也可以是一个运算符，这就叫函数。

其中运算符就带他后面的函数。

运算符后面的函数好多都是数值，但是有些是一个有运算符的函数。`(x+1)`是一个有运算符的函数。

看到了分开的`(x+1)`因为有括号，于是遇到括号就可以把括号里面的东西当成函数。

一开始的输入可以认为是一个函数。


```csharp
    1+2+sin(x+1)
```

可以认为是一个函数，然后里面包括3个函数。

函数可以包括函数。

那么第一个函数`1`就是数值1，第二个是`+2`，第三个是`(+(sin(x+1)))`

那么第三个函数里面是包括了一个函数 `sin(x+1)`，他里面包括两个函数`x` `+1`

于是很负责的函数可以分解了。

但是看到有些符号是双目的，那么双目如何去算？


```csharp
    1+2+sin(x+1)
```

首先是计算出第一个函数的值，数值的计算就是数值。返回`1`。计算第二个函数，第二个函数需要输入左边和右边的值，计算出了左边是`1`那么计算右边，可以看到第二个函数里面有一个函数，他的函数就是他右边的值，进入递归，求一个函数的值。

刚好就 `2` 于是返回，可以计算到第二个函数的值，是把左边`1`加右边`2`等于`3`。于是开始计算第三个函数，第三个函数需要传入左边和右边的值。于是进入递归，求他的函数。`sin(x+1)` 这个函数包括了一个函数，他是单目运算，单目运算需要计算他右边的值，于是进入递归，求函数`(x+1)`。可以看到这个函数有两个函数，一个是`x`一个是`+1`，按照刚才说的方法可以计算出来。于是返回`x+1`的值，于是`sin(x+1)` 就可以计算了，返回`sin(x+1)`计算 `1+2+sin(x+1)`于是得到结果。

![](http://7xqpl8.com1.z0.glb.clouddn.com/b1c4a6d3-5814-412d-9e7a-8daacd9208b82017220192822.jpg)

上面说的有点乱，于是我开始换个说法。

```csharp
    1+2+sin(x+1)
```

代替他


```csharp
    函数1 函数2 函数3
```

其中 函数1 是 `1` 。函数2 是 `+2` 。 函数3 是 `+sin(x+1)`

函数2.1 是 `2` 。函数3.1 是 `sin(x+1)` 。函数3.1.1 是 `x` 。函数3.1.2 是 `+1` 。

开始计算函数，需要计算出函数的所有函数。

计算函数1，得到1，放在左边结果。

计算函数2，需要计算 函数2.1 ，得到2。 于是计算函数2，需要左边结果和函数 2.1 结果，得到3，更新左边结果。

计算函数3，需要传入左边结果和函数 3.1 。开始计算函数3.1 计算函数3.1需要先计算函数 3.1.1 和函数 3.1.2 。

计算函数 3.1.1得到x 。计算函数3.1.2 需要传入左边结果，传入x，计算函数`1`得到 函数`(x+1)`。于是可以计算函数 3.1 得到`sin(x+1)`。计算函数3，得到`3+sin(x+1)`

可以看到，进入函数运算时，需要一个变量，左边结果。如果一个函数里有函数，那么递归进入函数运算。

进入函数运算需要判断是否是双目运算，如果是双目运算，需要去拿左边结果，并且每次运算完更新左边结果。

简单的思想就是这样。

但是这是双目运算没有优先级，那么双目运算有优先级的如何做？

可以看到`1+2*3`=`1+(2*3)`于是加上括号就好。

首先需要做出一个可以分割输入的函数分割。

## 函数分割

进入函数分割之前，需要判断输入是否合法。

需要转换所有小写。

可能用户输入是全角，需要使用大神的方法。

### 转全角

多谢 张善友 大神。

```csharp
        /// <summary> 转半角的函数(DBC case) </summary>
        /// <param name="str">任意字符串</param>
        /// <returns>半角字符串</returns>
        ///<remarks>
        ///全角空格为12288，半角空格为32
        ///其他字符半角(33-126)与全角(65281-65374)的对应关系是：均相差65248
        ///</remarks>
        private static string ToDBC(string str)
        {
            char[] c = str.ToCharArray();
            for (int i = 0; i < c.Length; i++)
            {
                if (c[i] == 12288)
                {
                    c[i] = (char)32;
                    continue;
                }
                if (c[i] > 65280 && c[i] < 65375)
                    c[i] = (char)(c[i] - 65248);
            }
            return new string(c);
        }
```

### 判断输入

```csharp
            var leftBracket = str.Count(temp => temp == '(');
            var rightBracket = str.Count(temp => temp == ')');
```

用简单方法，

不需要堆栈也可以。

判断用户有没输入不合法的字符，如中文。

这样做需要遍历字符串很多次。

如果存在`=`那么就是错误的。

其它的，我还没想好。

如果出现特殊字符，那么在判断是不是知道的，就错误了，不需要在这里，但是一旦出现了，性能有点下降。

先说下性能，在100次运行，算法需要的时间是100毫秒解析，也就是一次运行1毫秒。

在输入的函数，有重复符号`++` `--`，需要去他们，变成数学表示。

### 去重复符号


```csharp
            str = str.Replace("+-", "-");
            str = str.Replace("-+", "-");
            str = str.Replace("--", "+");
            str = str.Replace(" ", "");
```

最后需要去掉空格。

### 添加`*`

用户写入的字符串需要添加`*`。对于数值后面有括号，有变量，或其他的情况，就需要添加 `*` 。

对于 `1(2)` = `1*(2)`  `2sin(x)`=`2*sin(x)` 

简单方法是在读判断，如果读到括号，前面是数字，或读到字符前面是数字，那么添加`*`。如果`(`，字符前是`)`需要`*`。

算法：

 当前读括号：判断括号是`(`，并且之前是变量或数值，在`(`前添加`*`。

 判断括号是`)`，并且之后是变量或数值，在`)`后添加`*`。



### 分开数值

需要有好的性能，直接运行一次就可以算字符串的分割。

函数分割是一个数组，可以动态添加字符串，一个字符串就是一个分割。

如 `1+2*3` 函数分割就是 `{"1","+","2","*","3"}`

判断数值需要判断字符是不是数，是不是"."，对于"1..1"的错误输入，在解析报错，不在这里处理。

如果需要处理可以判断当前是不是"."，解析前面是否存在"."，如果存在，报错。如果不存在，设置存在"."。需要多一个bool，破坏储存方法，所以我不在这里使用。

如果要在这里使用，可以在函数写一个布尔，确定是否存在"."

算法：

 1. 遍历字符串

 2. 当前位置是否是数值

 3. 如果当前是数值
    添加当前到临时变量

 4. 如果当前是"."
    判断之前是否存在   "."
    如果之前存在 "."，报错
    如果之前不存在 "." ，
    添加当前到临时变量。
    设置存在 "."

 5. 其他字符，退出循环

 6. 记录临时变量到函数分割   

### 判断文字

如果第一个字符是文字，那么读取全部文字。

算法

 1. 遍历字符串

 2. 判断当前是不是文字，如果是文字，添加到临时变量

 3. 如果当前是操作符，或括号，那么结束循环

 4. 记录临时变量到函数分割

用C#方法是：

```csharp
     for (var i = 0; i < str.Length; i++)
```
判断是不是文字`char.IsLetter(ch)` ，读取文字全部


```csharp
     while (i + 1 < Express.Length && char.IsLetterOrDigit(Express[i + 1]))
```

<!-- ### 判断数字

判断数字 `char.IsDigit(ch)` 可以判断


```csharp
      while (i + 1 < Express.Length &&
                   (char.IsDigit(Express[i + 1]) || Express[i + 1] == '.'))
```

注意一个数可能不是只有数字。 -->



## 读函数分割



判断函数分割

 - 数值

 - 自变量

 - 函数

 - 括号

 - 特殊数学

 - 逗号

如果遇到数值，就新建`MathematicalFigure` 返回。

如果是自变量，返回 `MathematicalVariable`

如果是特殊数学，返回特殊数学（pi）。

如果是括号，那么进入递归。`mathematicalFunction`进入`EstablishMathematicalExpression`。

如果是右括号和逗号，结束。

如果是函数。

![](http://7xqpl8.com1.z0.glb.clouddn.com/b1d35729-aa05-43c9-9c4f-14a33c495e20201722291551.jpg)

函数很简单，但是有些函数需要向后读两个参数。

如果你知道逆波兰法，那么不用使用它，如果没听过他，那么最好。逆波兰法需要知道有哪些Opt，但是工程是可能以后有很多Opt，新的加到工程。

算法：

创建函数 读取函数，方法返回 数学函数，输入函数分割。

读取函数：

新建 函数 f。

循环读取函数分割。

 - 如果读取到是括号，调用 读取函数 获得函数 f1 添加到 f 。


```csharp
    f1=读取函数(函数分割);
    f.SubExpression.Add(f1);
```

 - 如果读取到是数值，那么添加数值到 f 。

 - 如果读取到函数，那么对用创建函数函数 f1，判断函数f1需要向后读取多少个函数，向后读取需要的函数。


```csharp
    f1=创建函数(函数);//读到sin就创建sin，读到什么可以创建什么
    for 0:f1需要函数
     f1.Add(读取函数);
    f.SubExpression.Add(f1);
```

 - 如果读取到自变量，新建自变量 ，放到f

 - 如果读取到数学变量，pi这些，新建，放到 f

 - 如果读到括号`)`，或逗号，函数结束

 - 如果读到其他，错误

这就是一个大的方法，然后需要写如何读数值，如何创建函数，如何创建变量。

还需要说为什么需要这样做。

文章很长，如果遇到不懂的，请和我说。


### 读取数值

需要把数值转实际类型。

一般把数值转double。

于是使用 `double.TryParse(mathApart, out num)`

如果遇到函数

那么向后读一个参数。

判断是不是双目函数，如果是双目函数，判断是不是向后读。

如果需要，向后读一个参数。

有些函数需要读两个函数。

如果函数是向前读，他的sub也是向前读的运算符，那么报错。


```csharp
    1**2
```

这是不对的。对于`*`是向前读的函数，那么他读到sub `*2`也是前读的运算符，那么报错。


首先需要做一个类，这个基础，我叫他函数，函数包括一切。`MathematicalFunction`用户输入的字符串就是一个函数。

然后创建数值`MathematicalFigure`存放静态数值。

创建特殊数学数字如`MathematicalPi`

创建`MathematicalVariable`自变量。

然后需要创建`+-*/`我叫他`MathOpt`

添加多的就是`MathOpt`，不知道以后会有什么函数。于是使用反射，可以得到所有的继承`MathOpt`的方法。

![](http://7xqpl8.com1.z0.glb.clouddn.com/AwCCAwMAItoFAMV+BQA28wYAAQAEAK4+AQBmQwIAaOgJAOjZ/201733163919.jpg)

需要创建一个类做函数，所有的函数继承他，运算也需要继承。

可以看到运算有单目和双目，可以使用 输入两个参数和输入一个参数的函数。

双目函数可以存在向后读两个，可以是左右读。对于一般的函数，都是左右读，如加。就是计算前面的值和后面的值。

运算可以认为都是从左向右，对于优先级，在下面处理，假设处理了，都是可以从左向右。所以需要拿出左边的值和右边的值计算。

左边的值已经计算完，对于右边的值，可以调用函数运算，通过右边运算得到右边的值。如果右边需要的是双目函数左边的值，那么把现在的值作为参数放进去，这样是递归运算。

看起来函数就是树，遍历树可以得到结果。

## 处理优先级

有些运算优先级比较高，可以看到最高的是`^`，然后是`*/`

于是需要判断是否包含运算高的函数，如果包含，也是双目，就需要从之前的函数拿出，放到优先高的子函数。

假如`1*2^2` 那么进过上面，得到 三个函数 `1` `*` `^` 其中`*`有一个子函数2.

这时发现存在优先高的`^` 于是提取左边函数，如果左边是运算符，那么拆开他获得子函数`2` ，把他添加到一个新的函数，然后添加 `^`到函数，这个函数就是`2^2`。把这个函数放在 `*`子函数，得到
`* (2^2)` 这样获得优先级。

优先级处理之后，就是可以返回一个函数，这个函数就是输入x输入结果，如果一个表达式没有包括 x 那么无论输入什么都不会影响结果。

对于输入出现的可能存在的 x 除数是0的情况，不可异常，返回 Nan，也就是运算得到一个不是数。

为何不可以出现异常，如果出现异常，那么无法往下计算，这个函数是为了可以计算图形，也就是输入一个表达式，可以返回表达式图形，所以计算是连续的，可能得到的计算的结果是错误的，这时就不显示，但是很多时候遇到错误不可以停下，如果停下了，对于一些表达式，本身就是需要有无法计算的，就无法显示。

关于函数，可以看一下：http://www.seewo.com/products/software/easinote.html 学科工具函数，里面的解析就是我做的

1/(1+2^x)


  
