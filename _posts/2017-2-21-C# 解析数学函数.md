---
layout: post
title:  C# 解析数学函数 
category: 技术 
---

最近需要做一功能，用户输入一次函数，我画出来。

于是我需要写一个函数，他可以把用户输入的数学函数转换为C# 代码。

<!--more-->

最简单方法，是把数学函数转化为C#代码，使用编译。

我的方法比较复杂。

下面来说下，不用编译直接解析用户输入的字符。

首先，需要知道，一个数学表达式可以写成：


```csharp
    1+2+3
```

也就是数值和运算，只有这两个，所以开始是需要把数和运算分出来。

然后发现运算有单目和双目。


```csharp
    sin(x+1)
```

其中 `sin` 就是单目运算，`+`就是双目运算。

于是可以认为每个项都可以分出来。


```csharp
    1+2+sin(x+1)= 1  (+2)  (+(sin(x+1)))
```

把数值和运算符算出的结果都看成一个类。

是的，他可以是一个数值、也可以是一个运算符，这就叫函数。

其中运算符就带他后面的函数。

运算符后面的函数好多都是数值，但是有些是一个有运算符的函数。`(x+1)`是一个有运算符的函数。

看到了分开的`(x+1)`因为有括号，于是遇到括号就可以把括号里面的东西当成函数。

一开始的输入可以认为是一个函数。


```csharp
    1+2+sin(x+1)
```

可以认为是一个函数，然后里面包括3个函数。

函数可以包括函数。

那么第一个函数`1`就是数值1，第二个是`+2`，第三个是`(+(sin(x+1)))`

那么第三个函数里面是包括了一个函数 `sin(x+1)`，他里面包括两个函数`x` `+1`

于是很负责的函数可以分解了。

但是看到有些符号是双目的，那么双目如何去算？


```csharp
    1+2+sin(x+1)
```

首先是计算出第一个函数的值，数值的计算就是数值。返回`1`。计算第二个函数，第二个函数需要输入左边和右边的值，计算出了左边是`1`那么计算右边，可以看到第二个函数里面有一个函数，他的函数就是他右边的值，进入递归，求一个函数的值。

刚好就 `2` 于是返回，可以计算到第二个函数的值，是把左边`1`加右边`2`等于`3`。于是开始计算第三个函数，第三个函数需要传入左边和右边的值。于是进入递归，求他的函数。`sin(x+1)` 这个函数包括了一个函数，他是单目运算，单目运算需要计算他右边的值，于是进入递归，求函数`(x+1)`。可以看到这个函数有两个函数，一个是`x`一个是`+1`，按照刚才说的方法可以计算出来。于是返回`x+1`的值，于是`sin(x+1)` 就可以计算了，返回`sin(x+1)`计算 `1+2+sin(x+1)`于是得到结果。

![](http://7xqpl8.com1.z0.glb.clouddn.com/b1c4a6d3-5814-412d-9e7a-8daacd9208b82017220192822.jpg)

上面说的有点乱，于是我开始换个说法。

```csharp
    1+2+sin(x+1)
```

代替他


```csharp
    函数1 函数2 函数3
```

其中 函数1 是 `1` 。函数2 是 `+2` 。 函数3 是 `+sin(x+1)`

函数2.1 是 `2` 。函数3.1 是 `sin(x+1)` 。函数3.1.1 是 `x` 。函数3.1.2 是 `+1` 。

开始计算函数，需要计算出函数的所有函数。

计算函数1，得到1，放在左边结果。

计算函数2，需要计算 函数2.1 ，得到2。 于是计算函数2，需要左边结果和函数 2.1 结果，得到3，更新左边结果。

计算函数3，需要传入左边结果和函数 3.1 。开始计算函数3.1 计算函数3.1需要先计算函数 3.1.1 和函数 3.1.2 。

计算函数 3.1.1得到x 。计算函数3.1.2 需要传入左边结果，传入x，计算函数`1`得到 函数`(x+1)`。于是可以计算函数 3.1 得到`sin(x+1)`。计算函数3，得到`3+sin(x+1)`

可以看到，进入函数运算时，需要一个变量，左边结果。如果一个函数里有函数，那么递归进入函数运算。

进入函数运算需要判断是否是双目运算，如果是双目运算，需要去拿左边结果，并且每次运算完更新左边结果。

简单的思想就是这样。

但是这是双目运算没有优先级，那么双目运算有优先级的如何做？

可以看到`1+2*3`=`1+(2*3)`于是加上括号就好。

首先需要做出一个可以分割输入的函数分割。

## 函数分割

进入函数分割之前，需要判断输入是否合法。

需要转换所有小写。

可能用户输入是全角，需要使用大神的方法。

### 转全角

多谢 张善友 大神。

```csharp
        /// <summary> 转半角的函数(DBC case) </summary>
        /// <param name="str">任意字符串</param>
        /// <returns>半角字符串</returns>
        ///<remarks>
        ///全角空格为12288，半角空格为32
        ///其他字符半角(33-126)与全角(65281-65374)的对应关系是：均相差65248
        ///</remarks>
        private static string ToDBC(string str)
        {
            char[] c = str.ToCharArray();
            for (int i = 0; i < c.Length; i++)
            {
                if (c[i] == 12288)
                {
                    c[i] = (char)32;
                    continue;
                }
                if (c[i] > 65280 && c[i] < 65375)
                    c[i] = (char)(c[i] - 65248);
            }
            return new string(c);
        }
```


```csharp
            var leftBracket = str.Count(temp => temp == '(');
            var rightBracket = str.Count(temp => temp == ')');
```

不需要堆栈也可以。

这样做需要遍历字符串很多次。

如果存在`=`那么就是错误的。

其它的，我还没想好。

如果出现特殊字符，那么在判断是不是知道的，就错误了，不需要在这里，但是一旦出现了，性能有点下降。

先说下性能，在100次运行，算法需要的时间是100毫秒解析，也就是一次运行1毫秒。

在输入的函数，有重复符号`++` `--`，需要去他们

### 去重复符号


```csharp
            str = str.Replace("+-", "-");
            str = str.Replace("-+", "-");
            str = str.Replace("--", "+");
            str = str.Replace(" ", "");
```

最后需要去掉空格。

需要有好的性能，直接运行一次就可以算字符串的分割。


```csharp
     for (var i = 0; i < str.Length; i++)
```
判断是不是文字`char.IsLetter(ch)` ，读取文字全部


```csharp
     while (i + 1 < Express.Length && char.IsLetterOrDigit(Express[i + 1]))
```

判断数字 `char.IsDigit(ch)`


```csharp
      while (i + 1 < Express.Length &&
                   (char.IsDigit(Express[i + 1]) || Express[i + 1] == '.'))
```

需要添加`*`

对于 `1(2)` = `1*(2)`  `2sin(x)`=`2*sin(x)` 

在读就需要判断，如果读到括号，前面是数字，或读到字符前面是数字，那么添加`*`。如果`(`，字符前是`)`需要`*`。

判断很简单，我就不说啦。














## 读函数分割



判断函数分割

 - 数值

 - 自变量

 - 函数

 - 括号

 - 特殊数学

 - 逗号

如果遇到数值，就新建`MathematicalFigure` 返回。

如果是自变量，返回 `MathematicalVariable`

如果是特殊数学，返回特殊数学（pi）。

如果是括号，那么进入递归。`mathematicalFunction`进入`EstablishMathematicalExpression`。

如果是右括号和逗号，结束。

如果是函数。

函数很简单，但是有些函数需要向后读两个参数。

如果遇到函数

那么向后读一个参数。

判断是不是双目函数，如果是双目函数，判断是不是向后读。

如果需要，向后读一个参数。

有些函数需要读两个函数。

如果函数是向前读，他的sub也是向前读的运算符，那么报错。


```csharp
    1**2
```

这是不对的。对于`*`是向前读的函数，那么他读到sub `*2`也是前读的运算符，那么报错。






